{% extends "base/base.html" %}
{% load static %}

{% block extrahead %}
<link rel="stylesheet" type="text/css" href="{% static 'css/book_report/detail_report.css' %}" />
{% endblock extrahead %}

<head>
	<title>Report Detail</title>
</head>

<body>
	{% block content %}
	<div class="container">
		<div class="report_detail_container">
			<div class="report_title">
				<div class="report_title_text">
					<div class="text">독후감 제목</div>
					<span class="date">{{book_report.created_at}} </span>
				</div>
				<div class="title">{{book_report.report_name}}</div> 
				
			</div>

			<div class="profile_container">
				<div class="profile_img">
					<img class="img" src="https://avatars.dicebear.com/api/{{ user.sex }}/{{ user.nickname }}.svg">
				</div>

				<div class="name"><span class="nickname">{{book_report.user.nickname}}</span></div>
			</div>

			<div class="book_info_container">
				<div class="book_img">
					<img src="{{book_report.book_img}}" class="book_cover">
				</div>
				<div class="book_info">
					<div class="book_name">
						<p class="book_name">
							<div class="text">책 제목</div>
							<div class="book_info_bar">
								{{book_report.book_name}}
							</div>
						</p>
					</div>
					
					<div class="author">
						<p class="author">
							<div class="text">글쓴이</div>
							<div class="book_info_bar">
								{{book_report.book_author}}
							</div>
						</p>
					</div>
					
					<div class="category">
						<p class="category">
							<div class="text">카테고리</div>
							<select name="book_category" id="book_category">
								<option value="default" selected>{{book_report.book_category}}</option>
								<option value="문학">문학</option>
								<option value="경제/경영">경제/경영</option>
								<option value="예술">예술</option>
								<option value="자기계발">자기계발</option>
								<option value="정치/사회">정치/사회</option>
								<option value="과학">과학</option>
								<option value="기술IT">기술/IT</option>
							</select>
						</p>
					</div>
					
				</div>
			</div>

			<div class="content_container">
				<div class="text">독후감 본문</div>
				<div class="report_content_container">
					<div class="report_content">{{book_report.content}}</div>
				</div>
			</div>			
			{% if book_report.image_upload %}
			<img src="{{book_report.image_upload.url}}" alt="">
			{% endif %}
			
			<div class="button_container">
				<div class="like_button">
					<button class="button" id="{{book_report.id}}" onclick="book_report_like(this.id)">
						좋아요
						<span class="submit_num" id="like_count">{{book_report.like.count}}</span>
					</button>
				</div>
				<div class="scrap_button">
					<button class="button" id="scrap">스크랩</button>
					<!-- <span class="scrap">15</span>   css 정렬 땜에 잠시 주석처리 -->
				</div>
			</div>

			<div class="CRUD_button">
				<form action="{% url 'book_report:edit' book_report.id %}">
					<input class="button" type="submit" value="편집" onClick="">
				</form>
				<form action="{% url 'book_report:delete' book_report_id %}">
					<input class="button" type="submit" value="삭제" onClick="">
				</form>
			</div>
		</div>

	
		<h3>댓글 N개</h3>
		<div class="comment_container">
			<div class="comment_navbar">
				<form action="{% url 'book_report:CreateComment' book_report_id %}" method="post">
					{% csrf_token %}
					<div class="profile_img">
						<img class="img" src="https://avatars.dicebear.com/api/{{ user.sex }}/{{ user.nickname }}.svg">
					</div>
					<div class="write_comment">
						<textarea name="comment_content" id="comment" cols="30" rows="2" placeholder="댓글 작성"></textarea>
					</div>
					<div class="comment_button">
						<input class="comment_btn" type="submit" value='작성' name="comment_submit">
					</div>
				</form>
			</div>

			<div class="comment_content_container">
				<div class="comment_content">
					{% for c in comment %}
					<div>
						<p>댓글 작성 : {{c.user.nickname}}</p>
						<p>댓글 내용 : {{c.content}}</p>
						<p>댓글 작성날짜 : {{c.created_at}}</p>
					</div>
					{% endfor %}

				</div>
			</div>
		</div>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script>

        axios.defaults.xsrfCookieName = 'csrftoken'
		axios.defaults.xsrfHeaderName = "X-CSRFTOKEN"

		const requestButton = document.querySelector("#scrap");
        const commentButton = document.querySelector(".comment_btn")
        const content = document.querySelector("#comment")
		const commentDiv = document.querySelector(".comment_content")
		const bookReportId = JSON.parse("{{ book_report_id|escapejs }}");

		commentButton.addEventListener("click", () => {
            sendComment(bookReportId, content.value);
            content.value = "";
		})

		requestButton.addEventListener('click', () => {
			requestMember(bookReportId);
		})

		const requestMember = async (id) => {
			const url = "scrap";
			await axios.post(url, { id });
		}

        const reformatDate = (dateTime) => {
            const date = dateTime.split("T")[0].split("-");
            const time = dateTime.split("T")[1].split(":");

            const year = date[0];
            const month = date[1].replace(/(^0+)/, "");
            const day = date[2];

            let hour = time[0];
            let datetime = "오전";
            const minute = time[1];

            if (Number(hour) > 12) {
                hour -= 12;
                datetime = "오후";
            }

            const reformat_date =
                year + "년 " + month + "월 " + day + "일 "
                + hour + ":" + minute + " " + datetime;

            return reformat_date;
		}

        const sendComment = async (book_report_id, text) => {
            const url = "comment"
			const response = await axios.post(url, {book_report_id, text})
            const div = document.createElement('div');
            const comment = response.data.comment;

            const nickname = document.createElement('p');
            const content = document.createElement('p');
            const created_at = document.createElement('p');

            const reformat_date = reformatDate(comment.created_at);

            nickname.innerText = "댓글 작성 : " + comment.nickname;
            content.innerText = "댓글 내용 : " + comment.content;
            created_at.innerText = "댓글 작성날짜 : " + reformat_date;


            div.appendChild(nickname);
            div.appendChild(content);
            div.appendChild(created_at);

            commentDiv.appendChild(div);

            window.scrollTo(0, document.body.scrollHeight);

		}

	</script>

	<script src="https://code.jquery.com/jquery-3.5.1.js"
		integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
	<script type="text/javascript">
		function book_report_like(id) {
			console.log("hi")
			$.ajax({
				url: "{%url 'book_report:likes'%}",
				data: {
					'book_report_id': id
				},
				dataType: "json",
				contentType: "application/json; charset:UTF-8",
				success: function (response) {
					$('#like_count').html(response.like_count)
				},
			})
		}
	</script>

	{% endblock content %}
</body>